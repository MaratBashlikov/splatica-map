# Варианты решения проблемы "плавающих" маркеров

## Проблема
HTML маркеры в Mapbox GL JS "плывут" при изменении зума/пана карты, так как они позиционируются через DOM transform, а не привязаны напрямую к координатам карты.

## Варианты решения

### Вариант 1: Symbol Layers (РЕКОМЕНДУЕТСЯ) ⭐
**Описание:** Использовать нативные Symbol Layers Mapbox GL JS вместо HTML маркеров.

**Плюсы:**
- ✅ Точное позиционирование, привязанное к координатам карты
- ✅ Нет "плавания" при зуме/пане
- ✅ Высокая производительность (рендеринг через WebGL)
- ✅ Автоматическое масштабирование при зуме

**Минусы:**
- ❌ Нужно рисовать иконки на canvas
- ❌ Сложнее реализовать hover/click эффекты
- ❌ Нужно переделать логику выбора маркеров

**Реализация:**
- Создать canvas иконки для каждого состояния маркера (обычный, hover, selected)
- Использовать GeoJSON source для точек
- Добавить symbol layer с кастомными иконками
- Обрабатывать события click/mouseenter/mouseleave на слое

---

### Вариант 2: Обновление позиций при движении карты
**Описание:** Принудительно обновлять позиции маркеров при каждом `moveend`/`zoomend`.

**Плюсы:**
- ✅ Простая реализация
- ✅ Сохраняет текущую HTML структуру маркеров
- ✅ Сохраняет все hover/click эффекты

**Минусы:**
- ❌ Может быть заметно визуально (маркеры "дергаются")
- ❌ Дополнительная нагрузка на производительность
- ❌ Не решает проблему полностью, только уменьшает

**Реализация:**
```typescript
useEffect(() => {
  if (!map.current || !isLoaded) return

  const updateMarkerPositions = () => {
    markersRef.current.forEach((marker) => {
      const currentPos = marker.getLngLat()
      // Принудительно обновить позицию
      marker.setLngLat([currentPos.lng, currentPos.lat])
    })
  }

  map.current.on('moveend', updateMarkerPositions)
  map.current.on('zoomend', updateMarkerPositions)

  return () => {
    if (map.current) {
      map.current.off('moveend', updateMarkerPositions)
      map.current.off('zoomend', updateMarkerPositions)
    }
  }
}, [isLoaded])
```

---

### Вариант 3: Canvas Overlay
**Описание:** Рисовать маркеры на canvas, который наложен поверх карты.

**Плюсы:**
- ✅ Полный контроль над рендерингом
- ✅ Стабильное позиционирование
- ✅ Можно использовать существующие стили

**Минусы:**
- ❌ Сложная реализация
- ❌ Нужно вручную обрабатывать все события (click, hover)
- ❌ Нужно синхронизировать canvas с картой при каждом движении

**Реализация:**
- Создать canvas элемент поверх карты
- При каждом `moveend`/`zoomend` перерисовывать все маркеры
- Использовать `map.project()` для преобразования координат в пиксели

---

### Вариант 4: Изменить anchor и offset
**Описание:** Экспериментировать с разными значениями `anchor` и `offset`.

**Плюсы:**
- ✅ Очень просто
- ✅ Может помочь с точностью позиционирования

**Минусы:**
- ❌ Скорее всего не решит проблему полностью
- ❌ Может ухудшить позиционирование в других местах

**Реализация:**
```typescript
const marker = new mapboxgl.Marker({
  element: el,
  anchor: 'center', // или 'top', 'bottom', 'left', 'right'
  offset: [0, -20] // смещение в пикселях [x, y]
})
```

---

### Вариант 5: Custom WebGL Layer
**Описание:** Создать кастомный WebGL слой для рендеринга маркеров.

**Плюсы:**
- ✅ Максимальная производительность
- ✅ Точное позиционирование
- ✅ Полный контроль

**Минусы:**
- ❌ Очень сложная реализация
- ❌ Требует знания WebGL
- ❌ Много кода

---

## Рекомендация

**Рекомендую Вариант 1 (Symbol Layers)** - это нативный способ Mapbox GL JS для отображения точек на карте, и он гарантирует правильное позиционирование.

Если нужен быстрый фикс с минимальными изменениями, можно попробовать **Вариант 2** (обновление позиций), но это не идеальное решение.

